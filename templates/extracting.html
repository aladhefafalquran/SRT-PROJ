<!-- templates/extracting.html -->
{% extends "base.html" %}

{% block title %}Extracting Subtitles...{% endblock %}
{% block header %}‚öôÔ∏è Extracting Subtitles from Video{% endblock %}

{% block content %}
    <p>Please wait while we extract subtitles using AI transcription.</p>

    <div class="progress-container">
        <div class="progress-bar" id="progressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
            <div class="progress-text" id="progressText">0%</div>
        </div>
    </div>

    <div id="statusText" class="pulse">Initializing...</div>

    <div class="terminal-container">
        <div class="terminal-output" id="terminalOutput">Starting transcription...
</div>
    </div>

    <button class="btn" style="background: #6c757d;" onclick="window.location.href='/'">
        <i class="fas fa-arrow-left"></i> Cancel & Return Home
    </button>
{% endblock %}

{% block scripts %}
<script>
    const uniqueId = '{{ conversion_id }}';

    const eventSource = new EventSource(`/video_status/${uniqueId}`);
    let lastLog = '';

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.status === 'in_progress' || data.status === 'completed') {
            const pct = data.progress || 0;
            document.getElementById('progressBar').style.width = `${pct}%`;
            document.getElementById('progressText').textContent = `${Math.round(pct)}%`;
            document.getElementById('statusText').textContent = data.message || 'Processing...';

            if (data.message && data.message !== lastLog) {
                const terminal = document.getElementById('terminalOutput');
                terminal.textContent += data.message + '\n';
                terminal.scrollTop = terminal.scrollHeight;
                lastLog = data.message;
            }
        }

        if (data.status === 'completed') {
            eventSource.close();
            showCompletionModal(true, data.data.srt_file);
        }

        if (data.status === 'error') {
            eventSource.close();
            showCompletionModal(false, null, data.message);
        }
    };

    eventSource.onerror = () => {
        setTimeout(checkFallback, 3000);
    };

    function checkFallback() {
        fetch(`/video_status/${uniqueId}`)
            .then(r => r.json())
            .then(data => {
                if (data.status === 'completed') {
                    showCompletionModal(true, data.data.srt_file);
                } else if (data.status === 'error') {
                    showCompletionModal(false, null, data.message);
                } else {
                    setTimeout(checkFallback, 3000);
                }
            })
            .catch(() => setTimeout(checkFallback, 5000));
    }

    function showCompletionModal(success, filename, errorMsg) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style = `
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        `;

        const isSuccess = success ? '‚úÖ' : '‚ùå';
        const title = success ? 'Success!' : 'Failed';
        const msg = success 
            ? 'Your subtitles have been extracted successfully.' 
            : errorMsg || 'An error occurred during processing.';

        const button = success
            ? `<a href="/download/${filename}" class="btn btn-success">üì• Download SRT</a>`
            : '';

        modal.innerHTML = `
            <div style="background: white; padding: 2rem; border-radius: 15px; text-align: center; max-width: 90%; width: 500px;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">${isSuccess}</div>
                <h2>${title}</h2>
                <p>${msg}</p>
                <div style="margin-top: 1rem;">
                    ${button}
                    <button onclick="window.location.href='/'" class="btn" style="background: #6c757d;">üè† Home</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        window.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };
    }
</script>
{% endblock %}