<!-- templates/edit_srt.html -->
{% extends "base.html" %}

{% block title %}Edit SRT File{% endblock %}
{% block header %}üìù Simple SRT Editor{% endblock %}

{% block content %}
<style>
    .editor-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .upload-area {
        text-align: center;
        padding: 2rem;
        background: #f8f9fa;
        border: 2px dashed #ccc;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
    
    .editor-area {
        display: none;
    }
    
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: white;
        border: 1px solid #ddd;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
    }
    
    .file-info {
        font-weight: bold;
        color: #333;
    }
    
    .toolbar-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-simple {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .btn-primary-simple {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .btn-simple:hover {
        background: #f8f9fa;
    }
    
    .btn-primary-simple:hover {
        background: var(--secondary-color);
    }
    
    .text-editor {
        width: 100%;
        min-height: 60vh;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 0 0 8px 8px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        resize: vertical;
        outline: none;
    }
    
    .text-editor:focus {
        border-color: var(--primary-color);
    }
    
    .status-bar {
        padding: 0.5rem 1rem;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        font-size: 0.8rem;
        color: #666;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    #rtlStatus {
        font-weight: bold;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        background: #e3f2fd;
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 1rem 0;
    }
    
    @media (max-width: 768px) {
        .toolbar {
            flex-direction: column;
            gap: 1rem;
        }
        
        .toolbar-buttons {
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-simple {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        
        .status-bar {
            flex-direction: column;
            gap: 0.25rem;
            text-align: center;
        }
    }
</style>

<div class="editor-container">
    <!-- Upload Area -->
    <div class="upload-area" id="uploadArea">
        <h3>üìÅ Upload SRT File</h3>
        <p style="margin: 1rem 0; color: #666;">Select an SRT file to edit as text</p>
        <input type="file" id="srtFile" accept=".srt" style="display: none;">
        <button onclick="document.getElementById('srtFile').click()" class="btn btn-primary">
            Choose SRT File
        </button>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <p>üìù Loading file...</p>
    </div>

    <!-- Editor Area -->
    <div class="editor-area" id="editorArea">
        <div class="toolbar">
            <div class="file-info" id="fileInfo">üìÑ filename.srt</div>
            <div class="toolbar-buttons">
                <button onclick="convertToRTL()" class="btn-simple" title="Add RTL marks for Arabic text">üîÄ Fix RTL</button>
                <button onclick="convertToLTR()" class="btn-simple" title="Remove RTL marks">üîÑ Remove RTL</button>
                <button onclick="downloadSRT()" class="btn-simple btn-primary-simple">üíæ Save & Download</button>
                <button onclick="newFile()" class="btn-simple">üìÑ New</button>
            </div>
        </div>
        
        <textarea 
            id="textEditor" 
            class="text-editor" 
            placeholder="Paste or edit your SRT content here...

Example format:
1
00:00:01,000 --> 00:00:04,000
Hello, this is the first subtitle.

2
00:00:05,000 --> 00:00:08,000
This is the second subtitle.

üí° For Arabic text: Use 'Fix RTL' button to add proper right-to-left formatting marks.
"></textarea>
        
        <div class="status-bar">
            <span id="lineCount">Lines: 0</span>
            <span id="rtlStatus"></span>
            <span style="font-size: 0.7rem; color: #999;">Ctrl+R: Fix RTL | Ctrl+Shift+R: Remove RTL</span>
            <span id="charCount">Characters: 0</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentFileName = '';

    document.getElementById('srtFile').addEventListener('change', loadFile);
    document.getElementById('textEditor').addEventListener('input', updateStats);

    function loadFile() {
        const fileInput = document.getElementById('srtFile');
        const file = fileInput.files[0];
        
        if (!file) return;

        currentFileName = file.name;
        
        document.getElementById('loading').style.display = 'block';
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            
            document.getElementById('textEditor').value = content;
            document.getElementById('fileInfo').textContent = `üìÑ ${currentFileName}`;
            
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('editorArea').style.display = 'block';
            
            updateStats();
        };
        
        reader.readAsText(file);
    }

    function updateStats() {
        const text = document.getElementById('textEditor').value;
        const lines = text.split('\n').length;
        const chars = text.length;
        
        // Check for RTL marks
        const hasRTL = text.includes('\u202B') || text.includes('\u202C');
        const arabicPattern = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
        const hasArabic = arabicPattern.test(text);
        
        document.getElementById('lineCount').textContent = `Lines: ${lines}`;
        document.getElementById('charCount').textContent = `Characters: ${chars}`;
        
        // RTL Status
        let rtlStatus = '';
        if (hasArabic && hasRTL) {
            rtlStatus = 'üîÄ RTL Fixed';
        } else if (hasArabic && !hasRTL) {
            rtlStatus = '‚ö†Ô∏è Arabic (needs RTL fix)';
        }
        document.getElementById('rtlStatus').textContent = rtlStatus;
    }

    function convertToRTL() {
        const textEditor = document.getElementById('textEditor');
        let content = textEditor.value;
        
        // Split content into lines
        let lines = content.split('\n');
        let result = [];
        
        // Arabic character pattern
        const arabicPattern = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
        
        for (let line of lines) {
            // Skip sequence numbers and timing lines
            if (line.match(/^\d+$/) || line.includes('-->') || line.trim() === '') {
                result.push(line);
                continue;
            }
            
            // If line contains Arabic text and doesn't already have RTL marks
            if (arabicPattern.test(line) && !line.includes('\u202B')) {
                // Add RLE (Right-to-Left Embedding) at start and PDF (Pop Directional Formatting) at end
                line = '\u202B' + line.trim() + '\u202C';
            }
            
            result.push(line);
        }
        
        textEditor.value = result.join('\n');
        updateStats();
        alert('‚úÖ RTL marks added to Arabic text lines!');
    }

    function convertToLTR() {
        const textEditor = document.getElementById('textEditor');
        let content = textEditor.value;
        
        // Remove all RTL marks
        content = content.replace(/[\u202A-\u202E\u200E\u200F]/g, '');
        
        textEditor.value = content;
        updateStats();
        alert('‚úÖ All RTL marks removed!');
    }

    async function downloadSRT() {
        const content = document.getElementById('textEditor').value;
        
        if (!content.trim()) {
            alert('Please enter some SRT content first.');
            return;
        }

        try {
            // Parse the content to validate SRT format
            const lines = content.trim().split('\n');
            let subtitles = [];
            let currentBlock = [];
            
            for (let line of lines) {
                if (line.trim() === '') {
                    if (currentBlock.length >= 3) {
                        // Process the block
                        const sequence = parseInt(currentBlock[0]);
                        const timing = currentBlock[1];
                        const text = currentBlock.slice(2).join('\n');
                        
                        if (!isNaN(sequence) && timing.includes('-->')) {
                            subtitles.push({
                                sequence: sequence,
                                start_time: timing.split('-->')[0].trim(),
                                end_time: timing.split('-->')[1].trim(),
                                text: text
                            });
                        }
                    }
                    currentBlock = [];
                } else {
                    currentBlock.push(line.trim());
                }
            }
            
            // Process last block if no empty line at end
            if (currentBlock.length >= 3) {
                const sequence = parseInt(currentBlock[0]);
                const timing = currentBlock[1];
                const text = currentBlock.slice(2).join('\n');
                
                if (!isNaN(sequence) && timing.includes('-->')) {
                    subtitles.push({
                        sequence: sequence,
                        start_time: timing.split('-->')[0].trim(),
                        end_time: timing.split('-->')[1].trim(),
                        text: text
                    });
                }
            }

            if (subtitles.length === 0) {
                alert('No valid SRT entries found. Please check the format.');
                return;
            }

            // Send to server to save
            const response = await fetch('/save_srt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subtitles: subtitles,
                    filename: currentFileName || 'edited.srt'
                })
            });

            const data = await response.json();

            if (data.success) {
                // Create download link
                const link = document.createElement('a');
                link.href = `/download/${data.filename}`;
                link.download = data.filename;
                link.click();
                
                alert('‚úÖ SRT file saved and download started!');
            } else {
                alert('Error saving file: ' + data.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    function newFile() {
        if (confirm('Create a new SRT file? Any unsaved changes will be lost.')) {
            document.getElementById('textEditor').value = `1
00:00:01,000 --> 00:00:04,000
Enter your first subtitle here.

2
00:00:05,000 --> 00:00:08,000
Enter your second subtitle here.

`;
            currentFileName = 'new.srt';
            document.getElementById('fileInfo').textContent = 'üìÑ new.srt';
            
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('editorArea').style.display = 'block';
            
            updateStats();
        }
    }

    // Auto-resize textarea and detect RTL needs
    document.getElementById('textEditor').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.max(400, this.scrollHeight) + 'px';
        updateStats();
    });

    // Keyboard shortcuts
    document.getElementById('textEditor').addEventListener('keydown', function(e) {
        // Ctrl/Cmd + R for RTL fix
        if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
            e.preventDefault();
            convertToRTL();
        }
        // Ctrl/Cmd + Shift + R for LTR (remove RTL)
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'R') {
            e.preventDefault();
            convertToLTR();
        }
    });
</script>
{% endblock %}